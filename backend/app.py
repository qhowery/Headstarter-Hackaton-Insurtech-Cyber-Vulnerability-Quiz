from flask import Flask, request, jsonify, render_template
from flask_cors import CORS
import replicate
import re

app = Flask(__name__)
CORS(app)  # Enable CORS for all routes

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/submit', methods=['POST'])
def submit():
    data = request.json
    name = data.get('name')
    email = data.get('email')
    age = data.get('age')
    user_type = data.get('user_type')
    org_size = data.get('org_size')
    industry = data.get('industry')

    user_info = f"""
    Name: {name}
    Email: {email}
    Age: {age}
    Type of User: {user_type}
    Organization Size: {org_size}
    Industry: {industry}
    """

    prompt_text = f"""
    Based on the following information, assess the cybersecurity risk on a 
    scale from 1 to 100, with 1 being most vulnerable and 100 being least vulnerable:

    {user_info}
    """

    # Make the API call to Replicate
    output = replicate.run(
        "meta/meta-llama-3.1-405b-instruct",
        input={"prompt": prompt_text}
    )

    # Function to parse the output
    def parse_output(output):
        # Find the first number in the response
        match = re.search(r'\d+', output)
        risk_score = int(match.group()) if match else None
        reasoning = output.strip()
        return risk_score, reasoning

    # Parse the output to get risk_score and reasoning
    risk_score, reasoning = parse_output(output)

    return jsonify({
        'risk_score': risk_score,
        'reasoning': reasoning
    })

if __name__ == '__main__':
    app.run(debug=True)


